<?php
    $m = $this->model;
    $promo = Denteva_Model_Promo::i();
?>

<?php if (!$this->mode || $this->mode==='view'): ?>

    <div class="adm-section-group">
        <div class="btns-set">
            <button class="btn st2 sz2 btn-edit" onclick="return adminForm.tabAction('edit', this);"><span>Edit</span></button>
           </div>
        <ul class="form-list">
            <li>
                <h4 class="label">Description</h4>
                <?php echo $this->q($m->description) ?>
            </li>
            <li>
                <h4 class="label">Manufacturer</h4>
                <?php echo $this->q($m->manuf()->vendor_name) ?>
            </li>
            <li>
                <h4 class="label">Date Range</h4>
                From <strong><?php echo BLocale::i()->datetimeDbToLocal($m->from_date) ?></strong>
                To <strong><?php echo BLocale::i()->datetimeDbToLocal($m->to_date) ?></strong>
            </li>
            <li>
                <h4 class="label">Promotion Structure</h4>
                <table class="adm-form-subtable">
                    <tr>
                        <td>BUY</td>
                        <td><strong><?php echo $this->q($promo->fieldOptions('buy_type', $m->buy_type)) ?></strong></td>
                        <td>FROM</td>
                        <td><strong><?php echo $this->q($promo->fieldOptions('buy_group', $m->buy_group)) ?></strong></td>
                        <td>GET</td>
                        <td><strong><?php echo $this->q($promo->fieldOptions('get_type', $m->get_type)) ?></strong></td>
                        <td>OF</td>
                        <td><strong><?php echo $this->q($promo->fieldOptions('get_group', $m->get_group)) ?></strong></td>
                    </tr>
                </table>
            </li>
            <li>
                <h4 class="label">Details</h4>
                <?php echo $m->details ?>
            </li>
        </ul>
    </div>

    <script>
    adminForm.wysiwygDestroy('model-details');
    </script>

<?php elseif ($this->mode==='create' || $this->mode==='edit'): ?>

    <fieldset class="adm-section-group">
<?php if ($this->mode!=='create'): ?>
        <div class="btns-set">
            <button class="btn st2 sz2 btn-cancel" onclick="return adminForm.tabAction('cancel', this);"><span>{{ 'Cancel'|_ }}</span></button>
            <button class="btn st1 sz2 btn-save" onclick="return adminForm.tabAction('save', this);"><span>Save</span></button>
        </div>
<?php endif ?>
        <ul class="form-list">
            <li>
                <h4 class="label">Description</h4>
                <input type="text" name="model[description]" value="<?php echo $this->q($m->description) ?>" style="width:90%"/>
            </li>
            <li>
                <h4 class="label">Manufacturer</h4>
                <input type="hidden" id="model-manuf_vendor_id" name="model[manuf_vendor_id]" value="<?php echo $this->q($m->manuf_vendor_id) ?>"/>
                <input type="text" id="model-manuf_vendor_id-autocomplete" value="<?php echo $m->manuf() ? $this->q($m->manuf()->vendor_name) : '' ?>" style="width:300px"/>
            </li>
            <li>
                <h4 class="label">Date Range</h4>
                From:
                <input type="text" id="model-from_date" name="model[from_date]" value="<?php echo BLocale::i()->datetimeDbToLocal($m->from_date) ?>" class="datepicker"/>
                To:
                <input type="text" id="model-to_date" name="model[to_date]" value="<?php echo BLocale::i()->datetimeDbToLocal($m->to_date) ?>" class="datepicker"/>
            </li>
            <li>
                <h4 class="label">Promotion Structure</h4>
                <table class="adm-form-subtable">
                    <tr>
                        <td>BUY</td>
                        <td><select name="model[buy_type]"><?php echo BUtil::optionsHtml($promo->fieldOptions('buy_type'), $m->buy_type) ?></select></td>
                        <td>FROM</td>
                        <td><select name="model[buy_group]"><?php echo BUtil::optionsHtml($promo->fieldOptions('buy_group'), $m->buy_group) ?></select></td>
                        <td>GET</td>
                        <td><select name="model[get_type]"><?php echo BUtil::optionsHtml($promo->fieldOptions('get_type'), $m->get_type) ?></select></td>
                        <td>OF</td>
                        <td><select name="model[get_group]"><?php echo BUtil::optionsHtml($promo->fieldOptions('get_group'), $m->get_group) ?></select></td>
                    </tr>
                </table>
            <li>
            <li>
                <h4 class="label">Details</h4>

                <textarea id="model-details" name="model[details]"><?php echo $this->q($m->details) ?></textarea>
            </li>
        </ul>
    </fieldset>
    <script>
    adminForm.wysiwygCreate('model-details');
    $('#model-from_date,#model-to_date').datepicker();
    var xhrCache = {}, lastXhr;
    $('#model-manuf_vendor_id-autocomplete').fcom_autocomplete({
        url:'<?php echo BApp::url('Denteva_Admin', '/vendors/autocomplete') ?>',
        field:'#model-manuf_vendor_id'
    });
    /*
    $('#model-manuf_vendor_id').autocomplete({
        minLength: 2,
        change: function( event, ui ) {
            if ( !ui.item ) {
                var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex( $(this).val() ) + "$", "i" ),
                    valid = false;
                $('#model-manuf_vendor_id').children( "option" ).each(function() {
                    if ( $( this ).text().match( matcher ) ) {
                        this.selected = valid = true;
                        return false;
                    }
                });
                if ( !valid ) {
                    // remove invalid value, as it didn't match anything
                    $( this ).val( "" );
                    $('#model-manuf_vendor_id').val( "" );
                    input.data( "autocomplete" ).term = "";
                    return false;
                }
            }
        }
        source: function(request, response) {
            var term = request.term;
            if (term in xhrCache) {
                response(xhrCache[term]);
                return;
            }
            lastXhr = $.getJSON('<?php echo BApp::m('Denteva_Admin')->baseHref().'/vendors/autocomplete'?>',
                request, function(data, status, xhr) {
                    xhrCache[term] = data;
                    if (xhr === lastXhr) {
                        response(data);
                    }
                });
        }
    });
    */
    </script>
<?php endif ?>
