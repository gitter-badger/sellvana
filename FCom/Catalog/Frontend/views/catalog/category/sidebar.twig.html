{% set rawGet = REQUEST.rawGet() %}
{% set category = THIS.get('category') ? THIS.get('category') : APP.get('current_category') %}
{% set parent = false %}
{% set siblings = false %}
{% if category %}
    {% if category.get('parent_id') %}
        {% set parent = APP.instance('FCom_Catalog_Model_Category').load(category.get('parent_id')) %}
        {% set siblings = category.siblings() %}
    {% endif %}
    {% set children = category.children() %}
{% endif %}

<section class="block block-filter">
   <header class="block-title"><span class="title">{{ "Narrow Results" |_ }}</span></header>
<form class="block-content" action="" method="get">
   <section class="block-sub">
	<header class="block-sub-title"><span class="title">{{ "Categories" |_ }}</span></header>
        <a href="{{ APP.href('catalog/search') ~ '?' ~ REQUEST.rawGet() }}">&lt; {{ "All categories" |_ }}</a>
        <ul>
        {% if category %}
            {% if parent and parent.get('node_name') %}
                <li style="padding-left: 10px;"><a href="{{ parent.url() ~ '?' ~ rawGet }}">&lt; {{ parent.get('node_name') }}</a></li>
            {% endif %}

            <li style="padding-left: 20px;"><b>{{ category.get('node_name') }}</b></li>

            {% for c in children %}
                <li style="padding-left: 30px;">
                    <a href="{{ c.url() ~ '?' ~ rawGet }}">{{ c.get('node_name') }}</a>
                </li>
            {% endfor %}

        {% endif %}
        {% if siblings %}
            {% for c in siblings %}
                <li style="padding-left: 20px;">
                    <a href="{{ c.url() ~ '?' ~ rawGet }}">{{ c.get('node_name') }}</a>
                </li>
            {% endfor %}
        {% endif %}
        </ul>
    </section>

    {{ THIS.hook('custom-fields-filters', { category: category }) | raw }}

</form>
</section>

