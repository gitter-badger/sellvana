{% set m = THIS.get('model') %}
{% set prodImagesConfig = APP.instance('FCom_Catalog_Admin_Controller_Products').productImagesGridConfig(m) %}
{% set mediaLibImageConfig = APP.instance('FCom_Admin_Controller_MediaLibrary').gridConfig({'id': 'all_images', 'folder': 'media/product/images'}) %}

<script>
var mediaGrid, imagesGrid;
require(['jquery','underscore','backbone'], function($, _) {
    var originIds, removedIds = [];
    var backboneGridAllImages, rowsAllImages;
    var mainThumb = $('#main-thumb-image');
    function _getAttachmentsDbFields(row) {
        return {
            id: row.id,
            file_id: row.file_id,
            label: row.label,
            position: row.position,
            _new: row._new
        };
    }

    /*
    *relect attachment grid data into form fields to send them server
    */
    window.setImagesGridVals = function() {

        removedIds = _.difference(originIds, imagesGrid.getRows().pluck('id'));

        var rows = [];
        imagesGrid.getRows().forEach(function(row) {
            rows.push(_getAttachmentsDbFields(row.toJSON()));
        });

        $('#prod-image-rows').val(JSON.stringify(rows));
        $('#prod-image-remove').val(removedIds.join(','));
    }

    /*
    *MediaGrid registery function
    */
    window.all_images_register = function(grid) {
        mediaGrid = grid;
        grid.build();

        backboneGridAllImages = mediaGrid.getGridSkeleton();
        rowsAllImages = mediaGrid.getRows();
        mediaGrid.getSelectedRows().on('add remove reset', function() {
            if (mediaGrid.getSelectedRows().length>0) {
                $('.prod-images-modal-add').removeClass('disabled');
            } else {
                $('.prod-images-modal-add').addClass('disabled');
            }
        });

        $('.prod-images-modal-add').click(function() {

            mediaGrid.getSelectedRows().forEach(function (row) {
                if (!imagesGrid.getRows().findWhere({file_id: row.get('id')})) {
                    var addedRow = row.toJSON();
                    addedRow._new = true;
                    addedRow.file_id = row.id;
                    addedRow.id = guid();
                    imagesGrid.getRows().add(addedRow);
                }
            });


            mediaGrid.getGridView().clearSelectedRows();
            $('.prod-attachments-modal-close').trigger('click');

        });
    }

    window.imagesGridRegister = function(grid) {

        imagesGrid = grid;
        var rowView = imagesGrid.getGridSkeleton().Views.RowView;
        rowView.prototype.afterRender = function() {
            var input = this.$el.find('.main-thumb');
            if (mainThumb.val() == '' && this.model.get('main_thumb') == 1) {
                input.prop('checked', true);
            }
            if (mainThumb.val() == this.model.get('id')) {
                input.prop('checked', true);
            }
        }

        rowView.prototype._deleteRow = function (ev) {
            var self = this;
            var confirmDelete = $('#confirm-delete-product-images');
            $('.prod-images-modal-delete').click(function () {
                imagesGrid.getRows().remove(self.model);
                imagesGrid.getSelectedRows().remove(self.model, {silent: true});
                self._destorySelf();
                confirmDelete.modal("hide");
            });
            var text = (this.model.get('associated_product') > 0) ?
                        "This image is associated with "+ this.model.get('associated_product') +" of products. Are you sure you want to delete?" : "Are you sure you want to delete?";
            confirmDelete.find('.modal-body').html(text);
            confirmDelete.modal('show');
        }
        imagesGrid.build();

        originIds = imagesGrid.getRows().pluck('id');
        console.log(originIds);

        $(imagesGrid.getGridSkeleton().AddButton).click(function() {
            refreshGridAdd();
            $('#btn_prod_image_modal').trigger('click');
        });

    }

    function refreshGridAdd() {
        var data = getExcludeId();
        backboneGridAllImages.current_filters['exclude_id'] = data;
        rowsAllImages.fetch({reset: true});
    }

    function getExcludeId() {
        var arr = imagesGrid.getRows().pluck('file_id');
        return  arr.join(',');
    }
});
    require(['tmpl', 'load-image', 'canvas-to-blob', 'iframe-transport', 'jquery.fileupload','jquery.fileupload-fp','jquery.fileupload-ui'], function() {
        $('#prod-image-fileupload').fileupload({
            url: '{{ APP.href("media/grid/upload?folder=media/product/images") | raw}}',
            multiple:true,
            acceptFileTypes:  /(jpg)|(jpeg)(tiff)|(gif)|(png)|(bmp)$/i
        })
        .bind('fileuploadalways', function(e, data) {

            if(data.result.id) {
                mediaGrid.getRows().add(data.result);

                $('td.name span').each(function(i) {
                    if($(this).html() === data.result.file_name)
                    $(this).parents('tr:first').remove();
                });

                if ($('#prod-attach-checkbox').is(':checked')) {

                    var addedRow = data.result;
                    addedRow._new = true;
                    addedRow.file_id = addedRow.id;
                    addedRow.id = guid();
                    imagesGrid.getRows().add(addedRow);

                    if ($('tr.template-upload').length === 0) {
                        $('.prod-images-modal-close').trigger('click');
                    }
                }
            }
        });

    });

</script>

{{ THIS.view('core/backbonegrid').set('grid', prodImagesConfig) | raw }}

<a role="button" href="#prod-image-grid-modal" data-toggle="modal" style='display:none;' id='btn_prod_image_modal'>{{ "Add"|_ }}</a>
<div class='modal fade' id='prod-image-grid-modal' tabindex='-1'>
    <div class='modal-dialog' style='width:1050px;'>
        <div class='modal-content'>
            <div class='modal-body'>
                <div class='row'>
                    <div class='col-sm-12'>
                    <div class='tabbable'>
                        <ul class='nav nav-tabs prod-type'>
                            <li class='active'>
                                <a data-toggle='tab' href='#images_library'>
                                    {{ 'Library'|_ }}
                                </a>
                            </li>
                            <li>
                                <a data-toggle='tab' href='#prod-image-fileupload'>
                                    {{ 'Upload'|_ }}
                                </a>
                            </li>
                        </ul>
                        <div class='tab-content'>
                            <div class='tab-pane active' id='images_library'>
                                {{ THIS.view('core/backbonegrid').set('grid', mediaLibImageConfig) | raw }}
                            </div>
                            <div class='tab-pane'  id='prod-image-fileupload'>
                                <div class='box-content'>
                                        <div class='row fileupload-buttonbar'>
                                                          <div class='col-sm-12'>
                                                            <span class='btn btn-success fileinput-button'>
                                                              <i class='icon-plus icon-white'></i>
                                                              <span>{{ 'Add files...'|_ }}</span>
                                                              <input data-bfi-disabled='' multiple='' name='upload[]' type='file' >
                                                            </span>
                                                            <button class='btn btn-primary start' type='submit'>
                                                              <i class='icon-upload icon-white'></i>
                                                              <span>{{ 'Start upload'|_ }}</span>
                                                            </button>
                                                            <button class='btn btn-warning cancel' type='reset'>
                                                              <i class='icon-ban-circle icon-white'></i>
                                                              <span>{{ 'Cancel upload'|_ }}</span>
                                                            </button>
                                                            <input class='toggle' type='checkbox' checked id='prod-image-checkbox'>&nbsp;{{ 'Add uploaded files and close'|_ }}
                                                          </div>
                                                          <div class='col-sm-5 fileupload-progress fade'>
                                                            <div aria-valuemax='100' aria-valuemin='0' class='progress progress-success progress-striped active' role='progressbar'>
                                                              <div class='bar' style='width:0%;'></div>
                                                            </div>
                                                            <div class='progress-extended'> </div>
                                                          </div>
                                        </div>
                                        <div class='fileupload-loading'></div>
                                        <br>
                                        <table class='table table-striped' role='presentation'>
                                            <tbody class='files' data-target='#modal-gallery' data-toggle='modal-gallery'></tbody>
                                        </table>

                                </div>
                                {% verbatim %}
                                <script id="template-upload" type="text/x-tmpl">
                                    {% for (var i=0, file; file=o.files[i]; i++) { %}
                                        <tr class="template-upload fade">
                                            <td class="preview"><span class="fade"></span></td>
                                            <td class="name"><span>{%=file.name%}</span></td>
                                            <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
                                            {% if (file.error) { %}
                                                <td class="error" colspan="2"><span class="label label-important">Error</span> {%=file.error%}</td>
                                            {% } else if (o.files.valid && !i) { %}
                                            <td>
                                                <div class="progress progress-success progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                                                    <div class="bar" style="width:0%;"></div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if (!o.options.autoUpload) { %}
                                                    <button class="btn btn-primary start">
                                                        <i class="icon-upload icon-white"></i>
                                                        <span>Start</span>
                                                    </button>
                                                {% } %}
                                            </td>
                                            {% } else { %}
                                                <td colspan="2"></td>
                                            {% } %}
                                            <td>
                                               {% if (!i) { %}
                                                <button class="btn btn-warning cancel">
                                                    <i class="icon-ban-circle icon-white"></i>
                                                    <span>Cancel</span>
                                                </button>
                                                {% } %}
                                            </td>
                                        </tr>
                                    {% } %}
                                </script>
                                <!-- The template to display files available for download -->

                                <script id="template-download" type="text/x-tmpl">
                                    {% for (var i=0, file; file=o.files[i]; i++) { %}
                                        <tr class="template-download fade">
                                           {% if (file.error) { %}
                                                <td></td>
                                                <td class="name"><span>{%=file.name%}</span></td>
                                                <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
                                                <td class="error" colspan="2"><span class="label label-important">Error</span> {%=file.error%}</td>
                                            {% } else { %}
                                                <td class="preview">
                                                {% if (file.thumbnail_url) { %}
                                                    <a href="{%=file.url%}" title="{%=file.name%}" data-gallery="gallery" download="{%=file.name%}">
                                                        <img src="{%=file.thumbnail_url%}">
                                                    </a>
                                                {% } %}
                                                </td>
                                                <td class="name">
                                                    <a href="{%=file.url%}" title="{%=file.name%}" data-gallery="{%=file.thumbnail_url&&'gallery'%}" download="{%=file.name%}">
                                                        {%=file.name%}
                                                    </a>
                                                </td>
                                                <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
                                                <td colspan="2"></td>
                                            {% } %}
                                            <td>
                                                <input type="checkbox" name="delete" value="1" class="toggle">
                                            </td>
                                        </tr>
                                    {% } %}
                                </script>
                                {% endverbatim %}
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary btn-add prod-images-modal-add disabled' data-dismiss='modal' type='button'>{{ "Add"|_ }}</button>
                <button class='btn btn-default btn-close prod-images-modal-close' data-dismiss='modal' type='button'>{{ "Close"|_ }}</button>
            </div>
        </div>
    </div>
</div>

<input type='hidden' name="grid[images][del]" id='prod-image-remove' />
<input type='hidden' name="grid[images][rows]" id='prod-image-rows' />
<input type='hidden' id='main-thumb-image' value="" />
<div class='modal fade' id='confirm-delete-product-images' tabindex='-1'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">{{ "Delete"|_ }}</h4>
                </div>
            <div class='modal-body'>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary btn-add prod-images-modal-delete' data-dismiss='modal' type='button'>{{ "Yes"|_ }}</button>
                <button class='btn btn-default btn-close' data-dismiss='modal' type='button'>{{ "Cancel"|_ }}</button>
            </div>
        </div>
    </div>
</div>
