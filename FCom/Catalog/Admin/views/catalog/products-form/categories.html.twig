{% set prodCtrl = APP.instance('FCom_Catalog_Admin_Controller_Products') %}

<div id="categories_unset"></div>
<div id="categories"></div>

<script>
    require(['jquery', 'fcom.admin', 'jstree'], function($) {
        $(function() {
            FCom.Admin.tree('#categories', {
                url:'#{BApp::href('catalog/categories/tree_data?id='.$this->model->id())}',
                checkbox: {
                    override_ui:true,
                    checked_parent_open:true,
                    real_checkboxes:true,
                    two_state: true
                },
                initially_open: {{ prodCtrl.linkedCategoriesData(THIS.model) }}
            });
            $('#categories').bind('loaded.jstree', function(event, data) {
                $('#categories').css({height:'auto'});
                var checked = {{ prodCtrl.linkedCategoriesData(THIS.model }};
                for (var id in checked) {
                    jQuery("<input>").attr("type", "hidden").attr("name", checked[id]).val(0).appendTo('#categories_unset');
                    data.inst.check_node('#'+checked[id]);
                }
            }).bind('after_open.jstree', function(event, data) {
                var checked = {{ prodCtrl.linkedCategoriesData(THIS.model) }};
                for (var id in checked) {
                    data.inst.check_node('#'+checked[id]);
                }
            });

            $('#categories').css({overflowY:'auto'}).resizeWithWindow({initBy:'.adm-content-box'});
        })
    });
</script>
