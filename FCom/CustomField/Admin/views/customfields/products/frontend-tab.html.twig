{% set prodCtrl = APP.instance('FCom_CustomField_Admin_Controller_Products') %}
{% set fieldSetsCtrl = APP.instance('FCom_CustomField_Admin_Controller_FieldSets') %}
<input type='hidden' id='prod_frontend_data' name='prod_frontend_data' />
<div class="row">
    <div class="col-sm-10">
        {{ THIS.view('core/backbonegrid').set('grid', prodCtrl.frontendFieldGrid(model))| raw }}
    </div>
</div>

<a role="button" href="#prod-frontend-add" data-toggle="modal" style='display:none;' id='btn_add_frontend'></a>
<div class='modal fade' id='prod-frontend-add' tabindex='-1'>
    <div class='modal-dialog' style='width:800px;'>
        <div class='modal-content'>
            <div class='modal-header'>
                <button aria-hidden='true' class='close' data-dismiss='modal' type='button'>Ã—</button>
                <h4 class='modal-title' id='myModalLabel'>{{ "Add products"|_ }}</h4>
            </div>
            <div class='modal-body'>
                {{ THIS.view('core/backbonegrid').set('grid', fieldSetsCtrl.fieldsetModalAddGridConfig()) | raw }}
            </div>
            <div class='modal-footer'>
                <button class='btn btn-default btn-close btn-prod-frontend-close' data-dismiss='modal' type='button'>{{ "Close"|_ }}</button>
            </div>
        </div>
    </div>
</div>



<script>
require(['backbone', 'underscore', 'jquery'], function(Backbone, _, $) {
    $('form#catalog-products-form').submit(function (ev) {
        var rows = mainRows.toJSON();

        var res = [];
        for (var i in rows) {
            res.push(_.pick(rows[i], 'id', 'name', 'label', 'input_type', 'price', 'options'));
        }

        $("#prod_frontend_data").val(JSON.stringify(res));
    });

    var modal_selectedRows;
    g_vent.trigger('get_selected_rows_collection', {
                grid: 'fieldset-modal-add-grid',
                callback: function (rows) {
                    modal_selectedRows = rows;
                }
            }
    );

    var mainRows;
    g_vent.trigger('get_rows_collection', {
                grid: 'frontend-field-grid',
                callback: function (rows) {
                    mainRows = rows;
                }
            }
                    );
    g_vent.bind('add', function (ev) {
        if (ev.grid === 'frontend-field-grid') {
            $('#btn_add_frontend').trigger('click');
        }

        if (ev.grid === 'fieldset-modal-add-grid') {
            var ids = modal_selectedRows.pluck('id').join(',');
            $.post('{{ APP.href('/customfields/products/get_fields') }}', {ids: ids}, function (response) {
                mainRows.add(response);
            });
            $('button.btn-prod-frontend-close').trigger('click');
            //g_vent.trigger('clear_selection', {grid: 'fieldset-modal-add-grid'});
        }
    });

    //TODO Figure out why calling g_vent.trigger()  in gvent_bind callback causes  very slowness...

});
</script>
