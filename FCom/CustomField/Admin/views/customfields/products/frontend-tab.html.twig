{% set prodCtrl = APP.instance('FCom_CustomField_Admin_Controller_Products') %}
{% set fieldSetsCtrl = APP.instance('FCom_CustomField_Admin_Controller_FieldSets') %}


<script>
require(['backbone', 'underscore', 'jquery'], function(Backbone, _, $) {
    var mainGrid, subGrid;
    var inputName = 'input[data-col="name"]';
    window.frontendFieldGridRegister = function(grid) {
        mainGrid = grid;
        grid.getGridSkeleton().Views.RowView.prototype.afterRender = function() {
            this.$el.find(inputName).addClass('unique');
        }
        grid.build();
    }
    $('#catalog-products-form').submit(function (ev) {
        var rows = mainGrid.getRows().toJSON();

        var res = [];
        for (var i in rows) {
            if (rows[i].position.length == 0) {
                rows[i].position = 0;
            }
            res.push(_.pick(rows[i], 'id', 'name', 'label', 'input_type', 'required', 'position'));
        }

        $("#prod_frontend_data").val(JSON.stringify(res));
    });
    function checkUnique(value, elem, params) {
        var error = true;
        if (typeof (elem) !== 'undefined') {
            mainGrid.getRows().each(function (data) {
                var parent = $(elem).parents('tr');
                if (parent.attr('id') != data.get('id') && parent.find(inputName).val() == data.get('name')) {
                    error = false;
                }
            });
        }

        return error;
    }

    $.validator.addMethod('checkUnique',checkUnique , 'Field Name are already taken place.');

    $.validator.addClassRules("unique", {
        required: true,
        checkUnique: true
    });

});
</script>

<input type='hidden' id='prod_frontend_data' name='prod_frontend_data' />
<div class="row">
    <div class="col-sm-10">
        {{ THIS.view('core/backbonegrid').set('grid', prodCtrl.frontendFieldGrid(model))| raw }}
    </div>
</div>




