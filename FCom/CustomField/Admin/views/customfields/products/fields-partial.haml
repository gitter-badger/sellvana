- $m = $this->model

%input(type="hidden" name="model[_fieldset_ids]" value="#{$m->_fieldset_ids}")
%input(type="hidden" name="model[_add_field_ids]" value="#{$m->_add_field_ids}" id="cf_add_fields_ids")
%input(type="hidden" name="model[_hide_field_ids]" value="#{$m->_hide_field_ids}" id="cf_hide_fields_ids")

- if(!empty($this->fields))
    %br
    %h2 = $this->_('Custom Fields')
    - foreach($this->fields as $field)
        %div(id="cf_field_#{$field->id}" style="margin-top: 15px;")
            %h3 = $field->frontend_label

            - if ($field->admin_input_type == 'select')
                %select(name="model[#{$field->field_code}]")
                    - foreach($this->fields_options[$field->id] as $field_option)
                        %option(value="#{$field_option->label}" #{$field_option->label == $m->{$field->field_code} ? 'selected':''})
                            = $field_option->label

            - elseif ($field->admin_input_type == 'text')
                - if ($field->table_field_type == 'date' || $field->table_field_type == 'datetime')
                    .datepicker_wrapper
                        %input(type="text" name="model[#{$field->field_code}]" value="#{$m->{$field->field_code}}" id="datepicker")
                    :javascript
                        require(['jquery', 'jquery-ui'], function($) {
                            $(function() {
                                $( "#datepicker" ).datepicker({ dateFormat: "yy-mm-dd", constrainInput: false });
                            });
                        })
                - else
                    %input(type="text" name="model[#{$field->field_code}]" value="#{$m->{$field->field_code}}")


            - elseif ($field->admin_input_type == 'textarea')
                %textarea(name="model[#{$field->field_code}]") = $m->{$field->field_code}

            - elseif ($field->admin_input_type == 'boolean')
                %select(name="model[#{$field->field_code}]")
                    - BUtil::optionsHtml(array(0=>'No', 1=>'Yes'), $m->{$field->field_code})

            - if (0==$field->system)
                %br
                %a(href="javascript:void(0);" onclick="cf_field_remove(#{$field->id})") = $this->_('remove')

-# %pre
    -# print_r(BDb::many_as_array($this->fields))
    -# print_r($m->as_array())


:javascript
    function cf_field_remove(field_id)
    {
        var addfields = $('#cf_add_fields_ids').val();
        var addfield_ar=addfields.split(",");
        for(fid in addfield_ar){
            if(addfield_ar[fid] == field_id){
                addfield_ar.splice(fid,1);
            }
        }
        var addfields_new = addfield_ar.join(",");
        var replaced = false;
        if(addfields_new != addfields){
            replaced = true;
            $('#cf_add_fields_ids').val(addfields_new);
        }

        if(false == replaced){
            var hidefields = $('#cf_hide_fields_ids').val();
            if(hidefields){
                $('#cf_hide_fields_ids').val(hidefields + ',' + field_id);
            } else {
                $('#cf_hide_fields_ids').val(field_id);
            }
        }
        //TODO: REMOVE FIELDS ONLY ON SAVE!
        $.ajax({
            url: "#{BApp::href('customfields/products/field_remove?id='.$m->id)}&hide_field="+field_id
        }).done(function() {
            $('#cf_field_'+field_id).remove();
        });

    }
