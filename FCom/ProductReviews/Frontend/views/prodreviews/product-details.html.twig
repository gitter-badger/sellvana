{% set isLoggedIn = APP.instance('FCom_Customer_Model_Customer').isLoggedIn() %}
{% set prod = THIS.get('prod') %}
{% set reviews = prod.reviews() %}
{% set rate = APP.instance('FCom_ProductReviews_Model_Review').config() %}

{% if isLoggedIn %}
<!-- Modal -->
<div class="modal fade" id="f-prod-review-form" tabindex="-1" role="dialog" aria-labelledby="f-prod-review-form-label" aria-hidden="true" data-backdrop="true">
  <div class="modal-dialog f-prod-review-form">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">{{ 'Review the Product'|_ }}</h4>
      </div>
      <div class="modal-body">
        {{ THIS.view('prodreviews/review-form').set({'prod': THIS.get('prod'), 'isModalBox': 1}) | raw }}
      </div><!-- /.modal-body -->
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
  require(['jquery'], function($) {
    $('#f-prod-review-open').attr('href', '#f-prod-review-form');
  })
</script>
{% endif %}

<section class="tab-pane active f-prod-reviews" id="f-prod-tab-reviews">
  <div class="f-tab-heading">
    <h5 class="f-tab-title">{{ 'Customer Reviews'|_ }}</h5>
    <a data-toggle="modal" href="{{ APP.href('prodreviews/add?pid=') ~ THIS.get('prod').id() }}" class="btn btn-sm btn-primary" id="f-prod-review-open">{{ 'Write your own review'|_ }}</a>
  </div>
    {% if (reviews.numReviews > 0) %}
  <div class="f-prod-review-avg clearfix">
    <h5>{{ "Avg. Customer Rating"|_ }} ({{ reviews.numReviews }} {{ "Reviews"|_ }}):</h5>
    <div class="glyphicon f-rating-stars f-lg-stars">
      <span class="f-filled-stars" style="width:{{ (reviews.avgRating.rating/rate.max)*100}}%;"></span>
      <span class="f-empty-stars"></span>
    </div>
    <strong>{{ reviews.avgRating.rating }} / {{ rate.max }}</strong>
    <div class="f-prod-review-attrs">
      <dl class="dl-horizontal">
        <dt>{{ "Value"|_ }}</dt>
        <dd>
          <div class="glyphicon f-rating-stars f-xs-stars">
            <span class="f-filled-stars" style="width:{{ (reviews.avgRating.rating1/rate.max)*100 }}%;"></span>
            <span class="f-empty-stars"></span>
          </div>
          {{ reviews.avgRating.rating1 }}</dd>
        <dt>{{ "Features"|_ }}</dt>
        <dd>
          <div class="glyphicon f-rating-stars f-xs-stars">
            <span class="f-filled-stars" style="width:{{ (reviews.avgRating.rating2/rate.max)*100 }}%;"></span>
            <span class="f-empty-stars"></span>
          </div>
            {{ reviews.avgRating.rating2 }}</dd>
        <dt>{{ "Quality"|_ }}</dt>
        <dd>
          <div class="glyphicon f-rating-stars f-xs-stars">
            <span class="f-filled-stars" style="width:{{ (reviews.avgRating.rating3/rate.max)*100 }}%;"></span>
            <span class="f-empty-stars"></span>
          </div>
            {{ reviews.avgRating.rating3 }}</dd>
      </dl>
    </div>
  </div>

    {% for review in reviews.items %}
  <article class="f-prod-review-post clearfix">
    <h5>{{ review.get('title') }}</h5>
    <span class="meta">{{ "by"|_ }} {{ review.get('firstname') }} {{ review.get('lastname') }} {{ "on"|_ }} {{ review.get('create_at')|date('F j, Y') }}</span>
    <div class="col-md-5 col-sm-5 f-prod-review-attrs">
      <dl class="dl-horizontal">
        <dt><strong>{{ "Overall"|_ }}</strong></dt>
        <dd>
          <div class="glyphicon f-rating-stars f-xs-stars">
            <span class="f-filled-stars" style="width:{{ (review.get('rating')/rate.max)*100 }}%;"></span>
            <span class="f-empty-stars"></span>
          </div>
          <strong>{{ review.get('rating') }} / {{ rate.max }}</strong>
        </dd>
        <dt>{{ "Value"|_ }}</dt>
        <dd>
          <div class="glyphicon f-rating-stars f-xs-stars">
            <span class="f-filled-stars" style="width:{{ (review.get('rating1')/rate.max)*100 }}%;"></span>
            <span class="f-empty-stars"></span>
          </div>
          {{ review.get('rating1') }}</dd>
        <dt>{{ "Features"|_ }}</dt>
        <dd>
          <div class="glyphicon f-rating-stars f-xs-stars">
            <span class="f-filled-stars" style="width:{{ (review.get('rating2')/rate.max)*100 }}%;"></span>
            <span class="f-empty-stars"></span>
          </div>
            {{ review.get('rating2') }}</dd>
        <dt>{{ "Quality"|_ }}</dt>
        <dd>
          <div class="glyphicon f-rating-stars f-xs-stars">
            <span class="f-filled-stars" style="width:{{ (review.get('rating3')/rate.max)*100 }}%;"></span>
            <span class="f-empty-stars"></span>
          </div>
            {{ review.get('rating3') }}</dd>
      </dl>
    </div>
    <div class="col-md-7 col-sm-7 f-prod-review">
      {{ review.get('text') }}
    </div>
  </article>
    {% endfor %}

    {% if (reviews.numReviews > 1) %}
        <p><a href="#"><strong>{{ "Read all %s customer reviews"|_(reviews.numReviews) }} &rsaquo;</strong></a></p>
    {% endif %}
    {% else %}
        <p>{{ "No reviews. Become first person review this products"|_ }}</p>
    {% endif %}
</section>
