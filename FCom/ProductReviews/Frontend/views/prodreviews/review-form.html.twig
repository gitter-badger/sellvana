{% set prod = THIS.get('prod') %}
{% set pr = THIS.get('pr') %}
{% set needApprove = CONFIG.get('modules/FCom_ProductReviews/need_approve') %}
{% set config = APP.instance('FCom_ProductReviews_Model_Review').config() %}
{% set max = config.max %}
{% set min = config.min %}
{% set step = config.step %}
{% set action = THIS.get('action') ? THIS.get('action') : 'add' %}
{% if (THIS.get('isModalBox') != 1) %}
    {% set validator = THIS.validator(THIS.get('formId')) %}
{% endif %}

{% if action == 'add' or (action == 'edit' and pr is not empty) %}
    <form action="{{ APP.href('prodreviews/' ~ action) }}" method="post" class="f-prod-reviews" id="f-prod-reviews-main-form">
        <input type="hidden" name="pid" value="{{ prod.id() }}">
        <input type="hidden" name="pr" value="{{ pr.id() }}" id="id-preview">

        <h1 class="f-prod-name">{{ prod.get('product_name') }}</h1>

        <div class="f-prod-review-attrs">
            <dl class="dl-horizontal">
                <dt><strong>{{ 'Overall'|_ }}</strong></dt>
                <dd>
                    <input class="validate[required]" type="range" id="prodreview-rating" name="review[rating]" min="{{ min }}" max="{{ max }}"
                            {% if pr %}
                                value="{{ pr.get('rating')}}"
                            {% else %}
                                value="{{ validator is defined and validator.fieldValue('rating') ? validator.fieldValue('rating') : min }}"
                            {% endif %}
                           step="{{ step }}" />
                    <div class="rateit" data-rateit-backingfld="#prodreview-rating"></div>
                </dd>
                <dt>{{ 'Value'|_ }}</dt>
                <dd>
                    <input class="required" type="range" id="prodreview-rating1" name="review[rating1]" min="{{ min }}" max="{{ max }}"
                            {% if pr %}
                                value="{{ pr.get('rating1')}}"
                            {% else %}
                                value="{{ validator is defined and validator.fieldValue('rating1') ? validator.fieldValue('rating1') : min }}"
                            {% endif %}
                           step="{{ step }}" />
                    <div class="rateit required" data-rateit-backingfld="#prodreview-rating1"></div>
                </dd>
                <dt>{{ 'Features'|_ }}</dt>
                <dd>
                    <input class="required" type="range" id="prodreview-rating2" name="review[rating2]" min="{{ min }}" max="{{ max }}"
                            {% if pr %}
                                value="{{ pr.get('rating2')}}"
                            {% else %}
                                value="{{ validator is defined and validator.fieldValue('rating2') ? validator.fieldValue('rating2') : min }}"
                            {% endif %}
                           step="{{ step }}" />
                    <div class="rateit " data-rateit-backingfld="#prodreview-rating2"></div>
                </dd>
                <dt>{{ 'Quality'|_ }}</dt>
                <dd>
                    <input type="range" id="prodreview-rating3" name="review[rating3]" min="{{ min }}" max="{{ max }}"
                            {% if pr %}
                                value="{{ pr.get('rating3')}}"
                            {% else %}
                                value="{{ validator is defined and validator.fieldValue('rating3') ? validator.fieldValue('rating3') : min }}"
                            {% endif %}
                           step="{{ step }}" />
                    <div class="rateit" data-rateit-backingfld="#prodreview-rating3"></div>
                </dd>
            </dl>
        </div>
        <div class="form-group">
            <label for="review-title">{{ 'Review Title'|_ }}</label>
            <div class="controls">
                <input type="text" id="prodreview-title" name="review[title]" placeholder="{{"Title" | _ }}" class="form-control required"
                        {% if pr %}
                            value="{{ pr.get('title')}}"
                        {% else %}
                            value="{{ validator is defined ? validator.fieldValue('title') : '' }}"
                        {% endif %} />
            </div>
        </div>
        <div class="form-group">
            <label for="review-text">{{ 'Review Text'|_ }}</label>
            <div class="controls">
                <textarea name="review[text]" id="prodreview-text" placeholder="{{"Your review here" | _ }}" class="form-control" style="resize:vertical">{% if pr %}{{ pr.get('text')}}{% else %}{{ validator is defined ? validator.fieldValue('text') : '' }}{% endif %}</textarea><br/>
            </div>
        </div>
        <input type="submit" class="btn btn-primary" id="review_save">
        {% if (THIS.get('isModalBox')) %}
            <input type="button" class="btn btn-link-cancel" data-dismiss="modal" value="{{ 'Cancel'|_ }}" />
        {% endif %}
        {% if (THIS.get('isModalBox') != 1) %}
            <a href="{{ prod.url() }}" class="btn">{{ "Return product"|_ }}</a>
        {% endif %}
    </form>
{% endif %}
<script>
    require(['jquery', 'jquery.rateit', 'jquery.bootstrap-growl', 'jquery.validate'], function($) {


        var mainForm = $('#f-prod-reviews-main-form');
        mainForm.validate();
        function validateForm () {
            var tmp = mainForm.valid();
            var label = '<label class="error">This field is required.</label>';
            $('#prodreview-rating').parent().children('label.error').remove();
            if ($('#prodreview-rating').val() == 0) {
                $('#prodreview-rating').parent().append(label);
                tmp = false;
            }
            return tmp;
        }
        $('input#review_save').click(function (ev) //todo: write function for same feature in fcom
        {
            var tmp = validateForm();

               if (tmp) {
                   {% if (THIS.get('isModalBox') == 1) %}
                       $.ajax({
                           type: "POST",
                           url: mainForm.attr('action'),
                           data: mainForm.serialize(),
                           success: function (data)
                           {
                               if (data.status == 'error') {
                                   $.bootstrapGrowl("Error:<br>" + data.message, { type: 'danger', align: 'center', width: 'auto', delay: 5000});
                               } else if (data.status == 'success'){
                                   var message = data.message || "Saved";
                                   $.bootstrapGrowl(message, { type: 'success', align: 'center', width: 'auto' });
                                   mainForm.parents('.fade').modal('hide');
                                   $("#f-prod-review-open").hide();
                                   mainForm[0].reset();
                                   mainForm.find('.rateit-reset').trigger('click');
                                   {% if needApprove == 0 %}
                                   //update list previews
                                   $('#f-prod-reviews-container').load('{{ APP.href('prodreviews/reviews_list') }}?pid={{ prod.id() }}');
                                   {% endif %}
                               } else {
                                   alert("Invalid data, please check again");
                               }
                           },
                           error: function (xhr, textStatus, errorThrown)
                           {
                               alert("[ERROR]<br>" + textStatus);
                           }
                       });
                   {% else  %}
                        return true;
                   {% endif %}

               }
                ev.preventDefault();
                ev.stopPropagation();

                return false;

        });

    });
</script>
