<!--{ label: Form Fields }-->
<!--{ pos: 30 }-->

{% set blockCtrl = APP.instance('FCom_Cms_Admin_Controller_Blocks') %}

<script type="text/javascript">
    require(['backbone', 'underscore', 'jquery'], function (Backbone, _, $) {
        var mainGrid;
        var inputName = 'input[data-col="name"]';
        var inputOption = 'input[data-col="options"]';
        var selectFieldType = 'select[data-col="input_type"]';
        window.formFieldGridRegister = function (grid) {
            mainGrid = grid;
            mainGrid.getGridSkeleton().Views.RowView.prototype.afterRender = function () {
                var self = this;
                this.$el.find(inputName).addClass('unique');
                this.$el.find(inputOption).addClass('requiredOptions');
                if (this.model.get('input_type') != 'select') {
                    this.$el.find(inputOption).prop('disabled', true);
                }
                this.$el.find(selectFieldType).change(function () {
                    if ($(this).val() == 'select') {
                        self.$el.find(inputOption).prop('disabled', false);
                    } else {
                        self.$el.find(inputOption).prop('disabled', true);
                    }
                })
            };
            mainGrid.build();
            $(mainGrid.getGridSkeleton().AddButton).click(function () {
                var $modal = $('#frontend-field-grid-modal');
                $modal.modal('show');
            });
        };
        $('#cms-blocks-form').submit(function (ev) {
            var rows = mainGrid.getRows().toJSON();

            var res = [];
            for (var i in rows) {
                if (rows[i].position.length == 0) {
                    rows[i].position = 0;
                }
                res.push(_.pick(rows[i], 'id', 'name', 'label', 'input_type', 'required', 'options', 'position'));
            }

            $("#block_form_fields_data").val(JSON.stringify(res));
        });
        function checkUnique(value, elem, params) {
            var error = true;
            if (typeof (elem) !== 'undefined') {
                var parent = $(elem).parents('tr');
                var val = parent.find(inputName).val();
                mainGrid.getRows().each(function (data) {
                    if (parent.attr('id') != data.get('id') && val == data.get('name')) {
                        error = false;
                    }
                });
            }

            return error;
        }

        $.validator.addMethod('checkUnique', checkUnique, 'Field Name are already taken place.');

        $.validator.addClassRules("requiredOptions", {
            required: function (value, elem, params) {
                var error = true;
                if (typeof (elem) !== 'undefined') {
                    var parent = $(elem).parents('tr');
                    if (parent.find(selectFieldType).val() == 'select' && value.trim().length == 0) {
                        error = false;
                    }
                }
                return error;
            }
        });

        $.validator.addClassRules("unique", {
            required: true,
            checkUnique: true
        });

    });
</script>

{{ forms.boolean(fieldData, {field:'form_enabled', label:'Form Enabled'|_}) }}

<input type='hidden' id='block_form_fields_data' name='block_form_fields_data'/>
<div class="row">
    <div class="col-sm-10">
        {{ THIS.view('core/backbonegrid').set('grid', blockCtrl.formFieldGrid(model))| raw }}
    </div>
</div>


<div class='modal fade' id='frontend-field-grid-modal' tabindex='-1'>
    <div class='modal-dialog'>
        <div class='modal-content'>
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">{{ "Add field"|_ }}</h4>
            </div>
            <div class='modal-body'>
                <div class=" field-element-wrapper">
                    <div class="form-group">
                        <div class="col-sm-5">
                            <div class="control-label col-sm-5"><label for="field_id">{{ "Field Id" }}</label></div>
                            <div class="control-label col-sm-7">
                                <input type="text" id="field_id" name="field_id" class="form-control">
                            </div>
                        </div>
                        <div class="col-sm-7">
                            <div class="control-label col-sm-4"><label for="field_type">{{ "Field Type"|_ }}</label>
                            </div>
                            <div class="controls col-sm-8">
                                <select name="field_type" class="form-control" id="field_type">
                                    <option value="text">{{"Single Line Text"|_}}</option>
                                    <option value="textarea">{{"Paragraph Text"}}</option>
                                    <option value="rte" >{{ "Rich Text"|_ }}</option>
                                    <option value="number" >{{ "Number"|_ }}</option>
                                    <option value="email" >{{ "Email Address"|_ }}</option>
                                    <option value="url" >{{ "Website/URL"|_ }}</option>
                                    <option value="image" >{{ "Image URL"|_ }}</option>
                                    <option value="file" >{{ "File Upload"|_ }}</option>
                                    <option value="date" >{{ "Date"|_ }}</option>
                                    <option value="phone" >{{ "Phone Number"|_ }}</option>
                                    <option value="hidden" >{{ "Hidden Field"|_ }}</option>
                                    <option value="time" >{{ "Time"|_ }}</option>
                                    <option value="password" >{{ "Password"|_ }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-4">
                            <div class="control-label col-sm-7">
                                <label for="field_required" class="frm_inline_label">{{ "Required"|_ }}</label>
                            </div>
                            <div class="col-sm-5">
                                <input type="checkbox" id="field_required" class="form-control" name="field_required"
                                       value="1" checked="checked">
                            </div>

                        </div>
                        <div class="col-sm-8">
                            <div class="control-label col-sm-5">
                                <label for="field_css_class">{{ "Additional CSS classes"|_ }}</label></div>
                            <div class="col-sm-7"><input type="text" name="field_css_class"
                                                         id="field_css_class" class="form-control" value=""></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-6">
                            <div class="control-label col-sm-5"><label for="field_default_value">{{ "Default Value"|_ }}</label></div>
                            <div class="col-sm-7"><input type="text" name="field_default_value"
                                                         id="field_default_value" class="form-control" value=""></div>
                        </div>
                        <div class="col-sm-6">
                            <div class="control-label col-sm-5"><label for="field_placeholder">{{ "Placeholder"|_ }}</label></div>
                            <div class="col-sm-7"><input type="text" name="field_placeholder"
                                                         id="field_placeholder" class="form-control" value=""/></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div width="150px"><label>{{ "Field Size"|_ }}</label></div>
                        <div>
                            <input type="text" name="field_options[size_50]" value="" size="5"> <span class="howto">columns wide</span>

                            <input type="text" name="field_options[max_50]" value="5" size="5"> <span class="howto">rows high</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div>{{ "Validation"|_ }}</div>
                        <div class="frm_validation_box">
                            <p class="frm_required_details50"><label>Required</label>
                                <input type="text" name="field_options[blank_50]"
                                       value="This field cannot be blank.">
                            </p>
                        </div>
                    </div>

                </div>
            </div>
            <div class='modal-footer'>
                <button class='btn btn-primary btn-add prod-images-modal-delete' data-dismiss='modal'
                        type='button'>{{ "Yes"|_ }}</button>
                <button class='btn btn-default btn-close' data-dismiss='modal' type='button'>{{ "Cancel"|_ }}</button>
            </div>
        </div>
    </div>
</div>
